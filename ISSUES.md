# cli-gateway Code Review Issues

> Generated by team review on 2026-02-07

## Issue Tracker

| # | Severity | Title | Owner | Status |
|---|----------|-------|-------|--------|
| 1 | P0 | Session 并发无锁，可能导致输出混乱 | Connie | Open |
| 2 | P0 | Session 文件写入无锁，并发可能损坏数据 | Connie | Open |
| 3 | P1 | config 中 max_sessions_per_user 未实现 | Connie | Open |
| 4 | P1 | config 中 cleanup_inactive_after_hours 未实现 | Connie | Open |
| 5 | P1 | Router 职责过重，命令解析/session管理/流式输出耦合 | Connie | Open |
| 6 | P1 | 流式输出无 Telegram API 限流保护 | Connie | Open |
| 7 | P2 | import time 在 _forward_to_agent 循环内而非文件顶部 | Connie | Open |
| 8 | P2 | kapybara 前缀解析硬编码切片，不够健壮 | Connie | Open |
| 9 | P2 | main.py 信号处理应用 loop.add_signal_handler | Connie | Open |

---

## Details

### #1 [P0] Session 并发无锁
**文件：** `core/router.py`, `agents/*.py`
**描述：** `session.is_busy` 仅为标记，无 `asyncio.Lock`。同一 session 并发请求会导致输出串流、状态竞争。
**建议：** 每个 session 加 `asyncio.Lock`，busy 时拒绝新请求。

### #2 [P0] Session 文件写入无锁
**文件：** `core/session.py`
**描述：** `_save()` 每次全量写 JSON，并发调用可能导致文件损坏。
**建议：** 加文件锁或使用 atomic write（写临时文件再 rename）。

### #3 [P1] max_sessions_per_user 未实现
**文件：** `core/session.py`, `config.example.yaml`
**描述：** 配置中定义了 `max_sessions_per_user: 5`，但 `create_session` 中没有任何检查。
**建议：** 在 `create_session` 中检查用户已有 session 数量。

### #4 [P1] cleanup_inactive_after_hours 未实现
**文件：** `core/session.py`, `config.example.yaml`
**描述：** 配置了过期清理时间但无清理逻辑。长期运行会堆积无用 session。
**建议：** 增加定时清理任务或在操作时懒清理。

### #5 [P1] Router 职责过重
**文件：** `core/router.py`
**描述：** Router 同时承担命令解析、参数校验、session 创建、流式输出、消息编辑等职责，违反 SRP。
**建议：** 拆分为 CommandParser、StreamHandler 等独立模块。

### #6 [P1] 流式输出无 API 限流保护
**文件：** `core/router.py` (`_forward_to_agent`)
**描述：** 每 2 秒 edit 一次消息，但未处理 Telegram 429 限流错误，可能丢失更新。
**建议：** 增加 retry + exponential backoff。

### #7 [P2] import time 位置不当
**文件：** `core/router.py` line ~在 `_forward_to_agent` 内部
**描述：** `import time` 写在函数循环体内，应移至文件顶部。

### #8 [P2] kapybara 前缀解析不健壮
**文件：** `core/router.py`
**描述：** `text[9:]` 硬编码切片依赖 "kapybara " 恰好 9 字符，不易维护。
**建议：** 使用 `text.split(None, 1)` 或正则提取。

### #9 [P2] 信号处理方式
**文件：** `main.py`
**描述：** 使用 `signal.signal()` 而非 asyncio 推荐的 `loop.add_signal_handler()`。
