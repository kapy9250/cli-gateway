# CLI Gateway Configuration Template
# Copy to config.yaml and fill in your values

# ──────────── 运行时实例 ────────────
# 可通过启动参数覆盖：
#   --mode session|system
#   --instance-id <id>
#   --config <path>
# CLI 启动时会注入环境变量：
#   CLI_GATEWAY_MODE, CLI_GATEWAY_INSTANCE_ID, INSTANCE_ID
runtime:
  mode: "${CLI_GATEWAY_MODE}"
  instance_id: "${CLI_GATEWAY_INSTANCE_ID}"
  namespace_paths: false  # If true, writable paths are auto-namespaced by instance_id

# ──────────── 鉴权 ────────────
# 全局设置：速率限制、管理员等
auth:
  max_requests_per_minute: 30
  admin_users:
    - 123456789  # Replace with your admin user ID
  system_admin_users:
    - 123456789  # Replace with your system-admin ID (for system mode operations)
  state_file: "./data/${CLI_GATEWAY_INSTANCE_ID}/auth_state.json"

# ──────────── Two-Factor (TOTP) ────────────
# For system-mode sensitive actions.
two_factor:
  enabled: false
  ttl_seconds: 300
  valid_window: 1
  period_seconds: 30
  digits: 6
  secrets:
    "123456789": "BASE32SECRETEXAMPLE"

# ──────────── System Ops (Gate 5 read-only) ────────────
system_ops:
  enabled: true
  max_read_bytes: 65536
  max_journal_lines: 300
  max_docker_output_bytes: 200000
  cron_dir: "/etc/cron.d"
  docker_bin: "docker"
  sensitive_read_paths:
    - "/etc/shadow"
    - "/etc/sudoers"
    - "/etc/ssh"
    - "/root"
    - "/home"
    - "/var/lib/docker"
  write_allowed_paths:
    - "/etc"
    - "/opt"
    - "/data"
    - "/var"
    - "/usr/local/etc"

# ──────────── Privileged System Service Bridge ────────────
# enabled=true 时，/sys 命令改为通过本地 Unix Socket 调用 root 侧 system_service_main.py。
# 2FA 通过后会签发短时授权票据，由 system service 二次验签后执行。
system_service:
  enabled: false
  socket_path: "/run/cli-gateway/system.sock"
  timeout_seconds: 10
  grant_secret: "CHANGE_ME_TO_A_LONG_RANDOM_SECRET"
  grant_ttl_seconds: 60
  # Optional: only allow requests from these local UNIX peer UIDs.
  # For example, set to the uid of the non-root gateway process.
  allowed_peer_uids: []
  request_timeout_seconds: 15
  max_request_bytes: 131072
  require_grant_ops:
    - "cron_upsert"
    - "cron_delete"
    - "docker_exec"
    - "config_write"
    - "config_append"
    - "config_delete"
    - "config_rollback"

# ──────────── 消息通道 ────────────
# 每个渠道有自己独立的 allowed_users 名单
# Telegram/Discord: 用户 ID (数字)
# Email: 发件人邮箱地址 (字符串)
channels:
  telegram:
    enabled: true
    token: "${TG_BOT_TOKEN}"  # Set via environment variable
    parse_mode: "HTML"
    max_message_length: 4096
    enforce_at_sender: true  # Always @ the sender in group replies
    allowed_users:
      - 123456789  # Replace with your Telegram user ID

  discord:
    enabled: false
    token: "${DISCORD_BOT_TOKEN}"  # Set via environment variable
    max_message_length: 2000
    allowed_guilds: []  # Empty = allow all guilds
    enforce_at_sender: true  # Always @ the sender in guild replies
    allow_bots: true  # When true, accepts messages from other Discord bots
    members_intent: false  # Set true if you need member info
    allowed_users:
      - 123456789  # Replace with your Discord user ID

  email:
    enabled: false
    imap_host: "imap.gmail.com"
    imap_port: 993
    smtp_host: "smtp.gmail.com"
    smtp_port: 587
    username: "${EMAIL_USERNAME}"
    password: "${EMAIL_PASSWORD}"
    poll_interval: 30  # seconds between inbox checks
    data_dir: "./data/email"  # per-sender storage (emails, attachments, sessions)
    allowed_users:  # Email address whitelist
      - "user@example.com"

# ──────────── Channel Rules ────────────
# Rules files in rules/ directory are auto-loaded per channel.
# They inject context into agent sessions so the AI knows
# which platform it's serving (telegram.md, discord.md, email.md).

# ──────────── CLI Agents ────────────
agents:
  claude:
    enabled: true
    display_name: "Claude Code"
    command: "claude"
    args_template: ["-p", "{prompt}", "--session-id", "{session_id}", "--output-format", "text"]
    interactive: false
    timeout: 300
    max_concurrent_sessions: 3
    env:
      CLAUDE_CODE_DISABLE_NONINTERACTIVE_CONSENT: "1"
    models:
      sonnet: "claude-sonnet-4-5"
      opus: "claude-opus-4-6"
      haiku: "claude-haiku-4-5"
    default_model: "sonnet"
    supported_params:
      model: "--model"
      thinking: "--thinking"
      max_turns: "--max-turns"
    default_params:
      thinking: "low"
  
  codex:
    enabled: false
    display_name: "GPT Codex"
    command: "codex"
    args_template: ["--prompt", "{prompt}", "--session", "{session_id}"]
    interactive: false
    timeout: 300
    max_concurrent_sessions: 3
    models:
      gpt5.3: "gpt-5.3-codex"
    default_model: "gpt5.3"
    supported_params:
      model: "--model"
      temperature: "--temperature"
      max_tokens: "--max-tokens"
    default_params: {}
  
  gemini:
    enabled: false
    display_name: "Gemini CLI"
    command: "gemini-cli"
    args_template: ["-p", "{prompt}"]
    interactive: false
    timeout: 300
    max_concurrent_sessions: 3
    models:
      gemini3: "gemini-3-pro-preview"
    default_model: "gemini3"
    supported_params:
      model: "-m"
      temperature: "--temp"
    default_params: {}

# ──────────── 账单 ────────────
# Billing files are stored outside the session workspace
# to prevent users from accessing cost data.
billing:
  dir: "./data/billing/${CLI_GATEWAY_INSTANCE_ID}"

# ──────────── Watchdog ────────────
watchdog:
  enabled: true
  check_interval: 30
  max_response_time: 120
  max_memory_per_session_mb: 512
  notify_on_restart: true

# ──────────── 会话管理 ────────────
session:
  workspace_base: "./workspaces/${CLI_GATEWAY_INSTANCE_ID}"
  cleanup_inactive_after_hours: 24
  cleanup_files_after_days: 7
  max_sessions_per_user: 5

# ──────────── 日志 ────────────
logging:
  level: "INFO"
  file: "./logs/${CLI_GATEWAY_INSTANCE_ID}/gateway.log"
  max_size_mb: 50
  backup_count: 3
  
  audit:
    enabled: true
    file: "./logs/${CLI_GATEWAY_INSTANCE_ID}/audit.log"

# ──────────── 健康检查 ────────────
# 多实例请使用不同端口（或启动时用 --health-port 覆盖）
health:
  host: "127.0.0.1"
  port: 18800
